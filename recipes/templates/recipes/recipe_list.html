{% extends 'recipes/base.html' %}

{% block title %}Recipes - Food Planner{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h4>My Recipes</h4>
        <div class="fixed-action-btn hide-on-large-only">
            <a class="btn-floating btn-large teal">
                <i class="large material-icons">add</i>
            </a>
            <ul>
                <li><a href="{% url 'recipe_create' %}" class="btn-floating green"><i class="material-icons">edit</i></a></li>
                <li><a href="#importModal" class="btn-floating blue modal-trigger"><i class="material-icons">file_upload</i></a></li>
            </ul>
        </div>
        <div class="hide-on-med-and-down">
            <a href="{% url 'recipe_create' %}" class="btn-floating btn-large waves-effect waves-light teal right" style="margin-left: 10px;">
                <i class="material-icons">add</i>
            </a>
            <a href="#importModal" class="btn-floating btn-large waves-effect waves-light blue right modal-trigger">
                <i class="material-icons">file_upload</i>
            </a>
        </div>
    </div>
</div>

<div id="importModal" class="modal">
    <div class="modal-content">
        <h4>Import Recipe</h4>
        <form id="importForm" enctype="multipart/form-data">
            <div class="file-field input-field">
                <div class="btn teal">
                    <span>File</span>
                    <input type="file" id="recipeFile" accept=".json">
                </div>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" placeholder="Select recipe JSON file">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-teal btn-flat">Cancel</a>
        <a href="#!" class="waves-effect waves-teal btn teal" onclick="importRecipe()">Import</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.modal');
    M.Modal.init(elems);
    var fab = document.querySelectorAll('.fixed-action-btn');
    M.FloatingActionButton.init(fab);
});

function importRecipe() {
    const fileInput = document.getElementById('recipeFile');
    const file = fileInput.files[0];
    
    if (!file) {
        M.toast({html: 'Please select a file'});
        return;
    }
    
    const formData = new FormData();
    formData.append('recipe_file', file);
    
    fetch('{% url "import_recipe_file" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            M.toast({html: 'Recipe imported successfully!'});
            setTimeout(() => location.reload(), 1000);
        } else {
            M.toast({html: 'Error: ' + data.error});
        }
    })
    .catch(error => {
        M.toast({html: 'Import failed'});
    });
}
</script>

<div class="row">
    {% for recipe in recipes %}
    <div class="col s12 m6 l4">
        <div class="card recipe-card">
            <div class="card-content">
                <span class="card-title truncate">{{ recipe.title }}</span>
                {% if recipe.source_url %}
                <span class="new badge teal" data-badge-caption="Imported"></span>
                {% endif %}
                <p><i class="material-icons tiny">restaurant</i> {{ recipe.ingredients.count }} ingredients</p>
                <p><i class="material-icons tiny">list</i> {{ recipe.steps.count }} steps</p>
                <p class="grey-text"><i class="material-icons tiny">schedule</i> {{ recipe.created_at|date:"M d, Y" }}</p>
            </div>
            <div class="card-action">
                <a href="{% url 'recipe_detail' recipe.pk %}" class="btn-small teal">View</a>
                <a href="{% url 'recipe_edit' recipe.pk %}" class="btn-small orange">Edit</a>
                <a href="{% url 'recipe_delete' recipe.pk %}" class="btn-small red">Delete</a>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col s12">
        <div class="card-panel center-align">
            <h5>No recipes yet</h5>
            <p>Start by creating your first recipe!</p>
            <a href="{% url 'recipe_create' %}" class="btn teal">Create Recipe</a>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}